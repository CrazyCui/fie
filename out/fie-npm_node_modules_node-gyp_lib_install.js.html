<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>共享FIE Source: fie-npm/node_modules/node-gyp/lib/install.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">共享FIE</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="fie-config.html">fie-config</a></li><li><a href="fie-fs.html">fie-fs</a></li><li><a href="fie-home.html">fie-home</a></li><li><a href="fie-log.html">fie-log</a></li><li><a href="fie-report.html">fie-report</a></li><li><a href="fie-user.html">fie-user</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="fie-fs.module_copy-directory.html">fie-fs.copy-directory</a></li><li><a href="fie-fs.module_copy-tpl.html">fie-fs.copy-tpl</a></li><li><a href="fie-fs.module_rewrite-file.html">fie-fs.rewrite-file</a></li><li><a href="module-fie-config.html">fie-config</a></li><li><a href="module-fie-home.html">fie-home</a></li><li><a href="module-fie-log.html">fie-log</a></li><li><a href="module-fie-report.html">fie-report</a></li><li><a href="module-fie-user.html">fie-user</a></li><li><a href="module-jodid25519.html">jodid25519</a></li><li><a href="module-jodid25519_core.html">jodid25519/core</a></li><li><a href="module-jodid25519_curve255.html">jodid25519/curve255</a></li><li><a href="module-jodid25519_dh.html">jodid25519/dh</a></li><li><a href="module-jodid25519_eddsa.html">jodid25519/eddsa</a></li><li><a href="module-jodid25519_utils.html">jodid25519/utils</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="-_.html">_</a></li><li><a href="FormData.html">FormData</a></li><li><a href="Promise.html">Promise</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html"></a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#accessLogDate">accessLogDate</a></li><li><a href="global.html#addOptionType">addOptionType</a></li><li><a href="global.html#address">address</a></li><li><a href="global.html#amdefine">amdefine</a></li><li><a href="global.html#argumentsToArray">argumentsToArray</a></li><li><a href="global.html#ArrayIndex">ArrayIndex</a></li><li><a href="global.html#Arrayish">Arrayish</a></li><li><a href="global.html#arrayProto">arrayProto</a></li><li><a href="global.html#arrayToPromise">arrayToPromise</a></li><li><a href="global.html#ascending">ascending</a></li><li><a href="global.html#assert">assert</a></li><li><a href="global.html#async">async</a></li><li><a href="global.html#asyncTag">asyncTag</a></li><li><a href="global.html#authorization">authorization</a></li><li><a href="global.html#base64decode">base64decode</a></li><li><a href="global.html#base64encode">base64encode</a></li><li><a href="global.html#bashCompletionFromOptions">bashCompletionFromOptions</a></li><li><a href="global.html#bashCompletionSpecFromOptions">bashCompletionSpecFromOptions</a></li><li><a href="global.html#boolTag">boolTag</a></li><li><a href="global.html#Buffer">Buffer</a></li><li><a href="global.html#bytes">bytes</a></li><li><a href="global.html#camelcase">camelcase</a></li><li><a href="global.html#canonicalizeHeaders">canonicalizeHeaders</a></li><li><a href="global.html#canonicalizeResource">canonicalizeResource</a></li><li><a href="global.html#charset">charset</a></li><li><a href="global.html#clean">clean</a></li><li><a href="global.html#CLONE_DEEP_FLAG">CLONE_DEEP_FLAG</a></li><li><a href="global.html#CLONE_SYMBOLS_FLAG">CLONE_SYMBOLS_FLAG</a></li><li><a href="global.html#co">co</a></li><li><a href="global.html#coerce">coerce</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#Command">Command</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#contentType">contentType</a></li><li><a href="global.html#convert">convert</a></li><li><a href="global.html#copy">copy</a></li><li><a href="global.html#Copy">Copy</a></li><li><a href="global.html#CORE_ERROR_TEXT">CORE_ERROR_TEXT</a></li><li><a href="global.html#createWritableStdioStream">createWritableStdioStream</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#datestruct">datestruct</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#decode">decode</a></li><li><a href="global.html#decodeBodyByCharset">decodeBodyByCharset</a></li><li><a href="global.html#decodeURIComponent">decodeURIComponent</a></li><li><a href="global.html#DEFAULT_TRUNC_LENGTH">DEFAULT_TRUNC_LENGTH</a></li><li><a href="global.html#defer">defer</a></li><li><a href="global.html#define">define</a></li><li><a href="global.html#Delegator">Delegator</a></li><li><a href="global.html#deprecate">deprecate</a></li><li><a href="global.html#descending">descending</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#dig">dig</a></li><li><a href="global.html#dir">dir</a></li><li><a href="global.html#disable">disable</a></li><li><a href="global.html#Domain">Domain</a></li><li><a href="global.html#domExcTag">domExcTag</a></li><li><a href="global.html#eifelerRegelAppliesToNumber">eifelerRegelAppliesToNumber</a></li><li><a href="global.html#enable">enable</a></li><li><a href="global.html#enabled">enabled</a></li><li><a href="global.html#encode">encode</a></li><li><a href="global.html#encodeURIComponent">encodeURIComponent</a></li><li><a href="global.html#ensureLength">ensureLength</a></li><li><a href="global.html#escape">escape</a></li><li><a href="global.html#escapeHtml">escapeHtml</a></li><li><a href="global.html#event">event</a></li><li><a href="global.html#EventEmitter">EventEmitter</a></li><li><a href="global.html#expectCommaSeparator">expectCommaSeparator</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#fd">fd</a></li><li><a href="global.html#fiePkg">fiePkg</a></li><li><a href="global.html#findAccessibleSync">findAccessibleSync</a></li><li><a href="global.html#finisher">finisher</a></li><li><a href="global.html#fmtLong">fmtLong</a></li><li><a href="global.html#fmtShort">fmtShort</a></li><li><a href="global.html#Foo">Foo</a></li><li><a href="global.html#format">format</a></li><li><a href="global.html#formatArgs">formatArgs</a></li><li><a href="global.html#formatters">formatters</a></li><li><a href="global.html#freeExports">freeExports</a></li><li><a href="global.html#freeModule">freeModule</a></li><li><a href="global.html#freeParseFloat">freeParseFloat</a></li><li><a href="global.html#freeParseInt">freeParseInt</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#FUNC_ERROR_TEXT">FUNC_ERROR_TEXT</a></li><li><a href="global.html#funcProto">funcProto</a></li><li><a href="global.html#funcToString">funcToString</a></li><li><a href="global.html#genify">genify</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getCommonData">getCommonData</a></li><li><a href="global.html#getIP">getIP</a></li><li><a href="global.html#getIPv6">getIPv6</a></li><li><a href="global.html#getLength">getLength</a></li><li><a href="global.html#getPadding">getPadding</a></li><li><a href="global.html#getParamNames">getParamNames</a></li><li><a href="global.html#getProjectEnv">getProjectEnv</a></li><li><a href="global.html#gyp">gyp</a></li><li><a href="global.html#has">has</a></li><li><a href="global.html#hash">hash</a></li><li><a href="global.html#hasOwnProperty">hasOwnProperty</a></li><li><a href="global.html#hmac">hmac</a></li><li><a href="global.html#hmacSha1">hmacSha1</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#humanReadableArgName">humanReadableArgName</a></li><li><a href="global.html#idCounter">idCounter</a></li><li><a href="global.html#inc">inc</a></li><li><a href="global.html#INFINITY">INFINITY</a></li><li><a href="global.html#inherits">inherits</a></li><li><a href="global.html#inspect">inspect</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isGenerator">isGenerator</a></li><li><a href="global.html#isGeneratorFunction">isGeneratorFunction</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isPromise">isPromise</a></li><li><a href="global.html#isSafeNumberString">isSafeNumberString</a></li><li><a href="global.html#iterate">iterate</a></li><li><a href="global.html#keys">keys</a></li><li><a href="global.html#load">load</a></li><li><a href="global.html#loadImplementation">loadImplementation</a></li><li><a href="global.html#localstorage">localstorage</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#logDate">logDate</a></li><li><a href="global.html#lookup">lookup</a></li><li><a href="global.html#map">map</a></li><li><a href="global.html#mapTag">mapTag</a></li><li><a href="global.html#MAX_ARRAY_LENGTH">MAX_ARRAY_LENGTH</a></li><li><a href="global.html#MAX_LENGTH">MAX_LENGTH</a></li><li><a href="global.html#MAX_SAFE_INTEGER">MAX_SAFE_INTEGER</a></li><li><a href="global.html#md5">md5</a></li><li><a href="global.html#moduleExports">moduleExports</a></li><li><a href="global.html#names">names</a></li><li><a href="global.html#NAN">NAN</a></li><li><a href="global.html#noop">noop</a></li><li><a href="global.html#notDefined">notDefined</a></li><li><a href="global.html#numberTag">numberTag</a></li><li><a href="global.html#objectCtorString">objectCtorString</a></li><li><a href="global.html#objectProto">objectProto</a></li><li><a href="global.html#objectTag">objectTag</a></li><li><a href="global.html#objectToPromise">objectToPromise</a></li><li><a href="global.html#Option">Option</a></li><li><a href="global.html#optionKeyFromName">optionKeyFromName</a></li><li><a href="global.html#osName">osName</a></li><li><a href="global.html#outFieHelpInfo">outFieHelpInfo</a></li><li><a href="global.html#outputHelpIfNecessary">outputHelpIfNecessary</a></li><li><a href="global.html#pad">pad</a></li><li><a href="global.html#parallel">parallel</a></li><li><a href="global.html#paramRegExp">paramRegExp</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#parseDate">parseDate</a></li><li><a href="global.html#Parser">Parser</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#PathArray">PathArray</a></li><li><a href="global.html#plural">plural</a></li><li><a href="global.html#prevColor">prevColor</a></li><li><a href="global.html#prevTime">prevTime</a></li><li><a href="global.html#prog">prog</a></li><li><a href="global.html#propertyIsEnumerable">propertyIsEnumerable</a></li><li><a href="global.html#punycode">punycode</a></li><li><a href="global.html#pureModuleName">pureModuleName</a></li><li><a href="global.html#qescRegExp">qescRegExp</a></li><li><a href="global.html#queryStringToSign">queryStringToSign</a></li><li><a href="global.html#quoteRegExp">quoteRegExp</a></li><li><a href="global.html#random">random</a></li><li><a href="global.html#randomSlice">randomSlice</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#read1">read1</a></li><li><a href="global.html#read2">read2</a></li><li><a href="global.html#ReadableAsyncKit">ReadableAsyncKit</a></li><li><a href="global.html#ReadableParallel">ReadableParallel</a></li><li><a href="global.html#ReadableSerial">ReadableSerial</a></li><li><a href="global.html#ReadableSerialOrdered">ReadableSerialOrdered</a></li><li><a href="global.html#reComboMark">reComboMark</a></li><li><a href="global.html#reEmptyStringLeading">reEmptyStringLeading</a></li><li><a href="global.html#reEscapedHtml">reEscapedHtml</a></li><li><a href="global.html#reEsTemplate">reEsTemplate</a></li><li><a href="global.html#reFlags">reFlags</a></li><li><a href="global.html#reIsBadHex">reIsBadHex</a></li><li><a href="global.html#reIsBinary">reIsBinary</a></li><li><a href="global.html#reIsOctal">reIsOctal</a></li><li><a href="global.html#reLatin">reLatin</a></li><li><a href="global.html#reNoMatch">reNoMatch</a></li><li><a href="global.html#replace">replace</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#reRegExpChar">reRegExpChar</a></li><li><a href="global.html#reTrim">reTrim</a></li><li><a href="global.html#reTrimEnd">reTrimEnd</a></li><li><a href="global.html#reTrimStart">reTrimStart</a></li><li><a href="global.html#reUnescapedHtml">reUnescapedHtml</a></li><li><a href="global.html#reUnescapedString">reUnescapedString</a></li><li><a href="global.html#rm">rm</a></li><li><a href="global.html#rsCombo">rsCombo</a></li><li><a href="global.html#rsComboMarksRange">rsComboMarksRange</a></li><li><a href="global.html#runCommand">runCommand</a></li><li><a href="global.html#runFunction">runFunction</a></li><li><a href="global.html#runJob">runJob</a></li><li><a href="global.html#s">s</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#selectColor">selectColor</a></li><li><a href="global.html#serial">serial</a></li><li><a href="global.html#serialOrdered">serialOrdered</a></li><li><a href="global.html#setEnv">setEnv</a></li><li><a href="global.html#setLength">setLength</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#sha1">sha1</a></li><li><a href="global.html#sha256">sha256</a></li><li><a href="global.html#shallowCopy">shallowCopy</a></li><li><a href="global.html#shouldPreferGlobalPromise">shouldPreferGlobalPromise</a></li><li><a href="global.html#sign">sign</a></li><li><a href="global.html#signQuery">signQuery</a></li><li><a href="global.html#slice">slice</a></li><li><a href="global.html#spawn">spawn</a></li><li><a href="global.html#spliceOne">spliceOne</a></li><li><a href="global.html#split">split</a></li><li><a href="global.html#state">state</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#streamer">streamer</a></li><li><a href="global.html#strictJSONParse">strictJSONParse</a></li><li><a href="global.html#stringTag">stringTag</a></li><li><a href="global.html#stringToSign">stringToSign</a></li><li><a href="global.html#Symbol">Symbol</a></li><li><a href="global.html#symbolTag">symbolTag</a></li><li><a href="global.html#symIterator">symIterator</a></li><li><a href="global.html#symlinkPaths">symlinkPaths</a></li><li><a href="global.html#synopsisFromOpt">synopsisFromOpt</a></li><li><a href="global.html#terminator">terminator</a></li><li><a href="global.html#TEXT_DATA_TYPES">TEXT_DATA_TYPES</a></li><li><a href="global.html#textwrap">textwrap</a></li><li><a href="global.html#thenify">thenify</a></li><li><a href="global.html#thenifyAll">thenifyAll</a></li><li><a href="global.html#thread">thread</a></li><li><a href="global.html#thunkify">thunkify</a></li><li><a href="global.html#thunkToPromise">thunkToPromise</a></li><li><a href="global.html#TIMEOUT">TIMEOUT</a></li><li><a href="global.html#timestamp">timestamp</a></li><li><a href="global.html#toPromise">toPromise</a></li><li><a href="global.html#toSafeNumber">toSafeNumber</a></li><li><a href="global.html#try">try</a></li><li><a href="global.html#tryAutoDetect">tryAutoDetect</a></li><li><a href="global.html#tty">tty</a></li><li><a href="global.html#typeRegExp">typeRegExp</a></li><li><a href="global.html#useColors">useColors</a></li><li><a href="global.html#userInfoGetter">userInfoGetter</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#utils">utils</a></li><li><a href="global.html#weakMapTag">weakMapTag</a></li><li><a href="global.html#weakSetTag">weakSetTag</a></li><li><a href="global.html#withCallback">withCallback</a></li><li><a href="global.html#WRAP_ARY_FLAG">WRAP_ARY_FLAG</a></li><li><a href="global.html#WRAP_BIND_FLAG">WRAP_BIND_FLAG</a></li><li><a href="global.html#WRAP_CURRY_FLAG">WRAP_CURRY_FLAG</a></li><li><a href="global.html#WRAP_CURRY_RIGHT_FLAG">WRAP_CURRY_RIGHT_FLAG</a></li><li><a href="global.html#WRAP_FLIP_FLAG">WRAP_FLIP_FLAG</a></li><li><a href="global.html#WRAP_PARTIAL_FLAG">WRAP_PARTIAL_FLAG</a></li><li><a href="global.html#WRAP_PARTIAL_RIGHT_FLAG">WRAP_PARTIAL_RIGHT_FLAG</a></li><li><a href="global.html#WRAP_REARG_FLAG">WRAP_REARG_FLAG</a></li><li><a href="global.html#wrapCallback">wrapCallback</a></li><li><a href="global.html#wrapIterator">wrapIterator</a></li><li><a href="global.html#wrapIteratorCallback">wrapIteratorCallback</a></li><li><a href="global.html#YYYYMMDD">YYYYMMDD</a></li><li><a href="global.html#YYYYMMDDHHmmss">YYYYMMDDHHmmss</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: fie-npm/node_modules/node-gyp/lib/install.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">
module.exports = exports = install

module.exports.test = { download: download, readCAFile: readCAFile }

exports.usage = 'Install node development files for the specified node version.'

/**
 * Module dependencies.
 */

var fs = require('graceful-fs')
  , osenv = require('osenv')
  , tar = require('tar')
  , rm = require('rimraf')
  , path = require('path')
  , crypto = require('crypto')
  , zlib = require('zlib')
  , log = require('npmlog')
  , semver = require('semver')
  , fstream = require('fstream')
  , request = require('request')
  , minimatch = require('minimatch')
  , mkdir = require('mkdirp')
  , processRelease = require('./process-release')
  , win = process.platform == 'win32'

function install (gyp, argv, callback) {

  var release = processRelease(argv, gyp, process.version, process.release)

  // ensure no double-callbacks happen
  function cb (err) {
    if (cb.done) return
    cb.done = true
    if (err) {
      log.warn('install', 'got an error, rolling back install')
      // roll-back the install if anything went wrong
      gyp.commands.remove([ release.versionDir ], function (err2) {
        callback(err)
      })
    } else {
      callback(null, release.version)
    }
  }

  // Determine which node dev files version we are installing
  log.verbose('install', 'input version string %j', release.version)

  if (!release.semver) {
    // could not parse the version string with semver
    return callback(new Error('Invalid version number: ' + release.version))
  }

  if (semver.lt(release.version, '0.8.0')) {
    return callback(new Error('Minimum target version is `0.8.0` or greater. Got: ' + release.version))
  }

  // 0.x.y-pre versions are not published yet and cannot be installed. Bail.
  if (release.semver.prerelease[0] === 'pre') {
    log.verbose('detected "pre" node version', release.version)
    if (gyp.opts.nodedir) {
      log.verbose('--nodedir flag was passed; skipping install', gyp.opts.nodedir)
      callback()
    } else {
      callback(new Error('"pre" versions of node cannot be installed, use the --nodedir flag instead'))
    }
    return
  }

  // flatten version into String
  log.verbose('install', 'installing version: %s', release.versionDir)

  // the directory where the dev files will be installed
  var devDir = path.resolve(gyp.devDir, release.versionDir)

  // If '--ensure' was passed, then don't *always* install the version;
  // check if it is already installed, and only install when needed
  if (gyp.opts.ensure) {
    log.verbose('install', '--ensure was passed, so won\'t reinstall if already installed')
    fs.stat(devDir, function (err, stat) {
      if (err) {
        if (err.code == 'ENOENT') {
          log.verbose('install', 'version not already installed, continuing with install', release.version)
          go()
        } else if (err.code == 'EACCES') {
          eaccesFallback()
        } else {
          cb(err)
        }
        return
      }
      log.verbose('install', 'version is already installed, need to check "installVersion"')
      var installVersionFile = path.resolve(devDir, 'installVersion')
      fs.readFile(installVersionFile, 'ascii', function (err, ver) {
        if (err &amp;&amp; err.code != 'ENOENT') {
          return cb(err)
        }
        var installVersion = parseInt(ver, 10) || 0
        log.verbose('got "installVersion"', installVersion)
        log.verbose('needs "installVersion"', gyp.package.installVersion)
        if (installVersion &lt; gyp.package.installVersion) {
          log.verbose('install', 'version is no good; reinstalling')
          go()
        } else {
          log.verbose('install', 'version is good')
          cb()
        }
      })
    })
  } else {
    go()
  }

  function getContentSha(res, callback) {
    var shasum = crypto.createHash('sha256')
    res.on('data', function (chunk) {
      shasum.update(chunk)
    }).on('end', function () {
      callback(null, shasum.digest('hex'))
    })
  }

  function go () {

    log.verbose('ensuring nodedir is created', devDir)

    // first create the dir for the node dev files
    mkdir(devDir, function (err, created) {
      if (err) {
        if (err.code == 'EACCES') {
          eaccesFallback()
        } else {
          cb(err)
        }
        return
      }

      if (created) {
        log.verbose('created nodedir', created)
      }

      // now download the node tarball
      var tarPath = gyp.opts.tarball
      var badDownload = false
        , extractCount = 0
        , gunzip = zlib.createGunzip()
        , extracter = tar.Extract({ path: devDir, strip: 1, filter: isValid })

      var contentShasums = {}
      var expectShasums = {}

      // checks if a file to be extracted from the tarball is valid.
      // only .h header files and the gyp files get extracted
      function isValid () {
        var name = this.path.substring(devDir.length + 1)
        var isValid = valid(name)
        if (name === '' &amp;&amp; this.type === 'Directory') {
          // the first directory entry is ok
          return true
        }
        if (isValid) {
          log.verbose('extracted file from tarball', name)
          extractCount++
        } else {
          // invalid
          log.silly('ignoring from tarball', name)
        }
        return isValid
      }

      gunzip.on('error', cb)
      extracter.on('error', cb)
      extracter.on('end', afterTarball)

      // download the tarball, gunzip and extract!

      if (tarPath) {
        var input = fs.createReadStream(tarPath)
        input.pipe(gunzip).pipe(extracter)
        return
      }

      try {
        var req = download(gyp, process.env, release.tarballUrl)
      } catch (e) {
        return cb(e)
      }

      // something went wrong downloading the tarball?
      req.on('error', function (err) {
        if (err.code === 'ENOTFOUND') {
          return cb(new Error('This is most likely not a problem with node-gyp or the package itself and\n' +
            'is related to network connectivity. In most cases you are behind a proxy or have bad \n' +
            'network settings.'))
        }
        badDownload = true
        cb(err)
      })

      req.on('close', function () {
        if (extractCount === 0) {
          cb(new Error('Connection closed while downloading tarball file'))
        }
      })

      req.on('response', function (res) {
        if (res.statusCode !== 200) {
          badDownload = true
          cb(new Error(res.statusCode + ' response downloading ' + release.tarballUrl))
          return
        }
        // content checksum
        getContentSha(res, function (_, checksum) {
          var filename = path.basename(release.tarballUrl).trim()
          contentShasums[filename] = checksum
          log.verbose('content checksum', filename, checksum)
        })

        // start unzipping and untaring
        req.pipe(gunzip).pipe(extracter)
      })

      // invoked after the tarball has finished being extracted
      function afterTarball () {
        if (badDownload) return
        if (extractCount === 0) {
          return cb(new Error('There was a fatal problem while downloading/extracting the tarball'))
        }
        log.verbose('tarball', 'done parsing tarball')
        var async = 0

        if (win) {
          // need to download node.lib
          async++
          downloadNodeLib(deref)
        }

        // write the "installVersion" file
        async++
        var installVersionPath = path.resolve(devDir, 'installVersion')
        fs.writeFile(installVersionPath, gyp.package.installVersion + '\n', deref)

        // Only download SHASUMS.txt if not using tarPath override
        if (!tarPath) {
          // download SHASUMS.txt
          async++
          downloadShasums(deref)
        }

        if (async === 0) {
          // no async tasks required
          cb()
        }

        function deref (err) {
          if (err) return cb(err)

          async--
          if (!async) {
            log.verbose('download contents checksum', JSON.stringify(contentShasums))
            // check content shasums
            for (var k in contentShasums) {
              log.verbose('validating download checksum for ' + k, '(%s == %s)', contentShasums[k], expectShasums[k])
              if (contentShasums[k] !== expectShasums[k]) {
                cb(new Error(k + ' local checksum ' + contentShasums[k] + ' not match remote ' + expectShasums[k]))
                return
              }
            }
            cb()
          }
        }
      }

      function downloadShasums(done) {
        log.verbose('check download content checksum, need to download `SHASUMS256.txt`...')
        var shasumsPath = path.resolve(devDir, 'SHASUMS256.txt')

        log.verbose('checksum url', release.shasumsUrl)
        try {
          var req = download(gyp, process.env, release.shasumsUrl)
        } catch (e) {
          return cb(e)
        }

        req.on('error', done)
        req.on('response', function (res) {
          if (res.statusCode !== 200) {
            done(new Error(res.statusCode + ' status code downloading checksum'))
            return
          }

          var chunks = []
          res.on('data', function (chunk) {
            chunks.push(chunk)
          })
          res.on('end', function () {
            var lines = Buffer.concat(chunks).toString().trim().split('\n')
            lines.forEach(function (line) {
              var items = line.trim().split(/\s+/)
              if (items.length !== 2) return

              // 0035d18e2dcf9aad669b1c7c07319e17abfe3762  ./node-v0.11.4.tar.gz
              var name = items[1].replace(/^\.\//, '')
              expectShasums[name] = items[0]
            })

            log.verbose('checksum data', JSON.stringify(expectShasums))
            done()
          })
        })
      }

      function downloadNodeLib (done) {
        log.verbose('on Windows; need to download `' + release.name + '.lib`...')
        var dir32 = path.resolve(devDir, 'ia32')
          , dir64 = path.resolve(devDir, 'x64')
          , libPath32 = path.resolve(dir32, release.name + '.lib')
          , libPath64 = path.resolve(dir64, release.name + '.lib')

        log.verbose('32-bit ' + release.name + '.lib dir', dir32)
        log.verbose('64-bit ' + release.name + '.lib dir', dir64)
        log.verbose('`' + release.name + '.lib` 32-bit url', release.libUrl32)
        log.verbose('`' + release.name + '.lib` 64-bit url', release.libUrl64)

        var async = 2
        mkdir(dir32, function (err) {
          if (err) return done(err)
          log.verbose('streaming 32-bit ' + release.name + '.lib to:', libPath32)

          try {
            var req = download(gyp, process.env, release.libUrl32, cb)
          } catch (e) {
            return cb(e)
          }

          req.on('error', done)
          req.on('response', function (res) {
            if (res.statusCode !== 200) {
              done(new Error(res.statusCode + ' status code downloading 32-bit ' + release.name + '.lib'))
              return
            }

            getContentSha(res, function (_, checksum) {
              contentShasums[release.libPath32] = checksum
              log.verbose('content checksum', release.libPath32, checksum)
            })

            var ws = fs.createWriteStream(libPath32)
            ws.on('error', cb)
            req.pipe(ws)
          })
          req.on('end', function () {
            --async || done()
          })
        })
        mkdir(dir64, function (err) {
          if (err) return done(err)
          log.verbose('streaming 64-bit ' + release.name + '.lib to:', libPath64)

          try {
            var req = download(gyp, process.env, release.libUrl64, cb)
          } catch (e) {
            return cb(e)
          }

          req.on('error', done)
          req.on('response', function (res) {
            if (res.statusCode !== 200) {
              done(new Error(res.statusCode + ' status code downloading 64-bit ' + release.name + '.lib'))
              return
            }

            getContentSha(res, function (_, checksum) {
              contentShasums[release.libPath64] = checksum
              log.verbose('content checksum', release.libPath64, checksum)
            })

            var ws = fs.createWriteStream(libPath64)
            ws.on('error', cb)
            req.pipe(ws)
          })
          req.on('end', function () {
            --async || done()
          })
        })
      } // downloadNodeLib()

    }) // mkdir()

  } // go()

  /**
   * Checks if a given filename is "valid" for this installation.
   */

  function valid (file) {
    // header files
    return minimatch(file, '*.h', { matchBase: true }) ||
           minimatch(file, '*.gypi', { matchBase: true })
  }

  /**
   * The EACCES fallback is a workaround for npm's `sudo` behavior, where
   * it drops the permissions before invoking any child processes (like
   * node-gyp). So what happens is the "nobody" user doesn't have
   * permission to create the dev dir. As a fallback, make the tmpdir() be
   * the dev dir for this installation. This is not ideal, but at least
   * the compilation will succeed...
   */

  function eaccesFallback () {
    var tmpdir = osenv.tmpdir()
    gyp.devDir = path.resolve(tmpdir, '.node-gyp')
    log.warn('EACCES', 'user "%s" does not have permission to access the dev dir "%s"', osenv.user(), devDir)
    log.warn('EACCES', 'attempting to reinstall using temporary dev dir "%s"', gyp.devDir)
    if (process.cwd() == tmpdir) {
      log.verbose('tmpdir == cwd', 'automatically will remove dev files after to save disk space')
      gyp.todo.push({ name: 'remove', args: argv })
    }
    gyp.commands.install(argv, cb)
  }

}

function download (gyp, env, url) {
  log.http('GET', url)

  var requestOpts = {
      uri: url
    , headers: {
        'User-Agent': 'node-gyp v' + gyp.version + ' (node ' + process.version + ')'
      }
  }

  var cafile = gyp.opts.cafile
  if (cafile) {
    requestOpts.ca = readCAFile(cafile)
  }

  // basic support for a proxy server
  var proxyUrl = gyp.opts.proxy
              || env.http_proxy
              || env.HTTP_PROXY
              || env.npm_config_proxy
  if (proxyUrl) {
    if (/^https?:\/\//i.test(proxyUrl)) {
      log.verbose('download', 'using proxy url: "%s"', proxyUrl)
      requestOpts.proxy = proxyUrl
    } else {
      log.warn('download', 'ignoring invalid "proxy" config setting: "%s"', proxyUrl)
    }
  }

  var req = request(requestOpts)
  req.on('response', function (res) {
    log.http(res.statusCode, url)
  })

  return req
}

function readCAFile (filename) {
  // The CA file can contain multiple certificates so split on certificate
  // boundaries.  [\S\s]*? is used to match everything including newlines.
  var ca = fs.readFileSync(filename, 'utf8')
  var re = /(-----BEGIN CERTIFICATE-----[\S\s]*?-----END CERTIFICATE-----)/g
  return ca.match(re)
}
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	©2016 FIE-Team   |   旺旺交流群 1455030646
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a>
	
		on Fri Nov 18th 2016
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
